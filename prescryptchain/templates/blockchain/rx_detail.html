{% extends "base.html" %}
{% load static %}
{% load tz %}
{% block title %}
  Rx Detail
{% endblock title %}
{% block subtitle %}
  <h2 style="color:#000; margin-left:4em; font-weight:700;">Details of the transaction</h2>
{% endblock subtitle %}
{% block content %}
  {# TX Detail #}
  <section class="container-fluid bg-midnight">
    <div class="row padding-2em">
      <div class="col-xs-12 col-lg-8 col-lg-offset-2">
        <div class="row">
          <article class="shadowed_details col-xs-12 col-lg-6">
            {# Rx info #}
            <table style="margin-bottom:0px!important;" id="crypto-table" class="table table-striped">
              <tr>
                <td class="a_grey" colspan="2"><strong>Details</strong></td>
              </tr>
              {# for field in prescription #}
              <tr><td class="a_grey" colspan="2"><strong>Genomic Country Data:</strong></td></tr>
              <section class="a_grey" class="countries">
              {% for country in rx.data %}
                <tr>
                  <td class="a_grey">Country Name {{ forloop.counter }}:</td>
                  <td class="a_grey country_name">{{ country.country_name }}</td>
                </tr>
                <tr>
                  <td class="a_grey">Percentage {{ forloop.counter }}:</td>
                  <td class="a_grey percentage">{{ country.percentage }}</td>
                </tr>
              {% endfor %}
              </section>
              </table>
          </article>

          <article class="shadowed_details col-xs-12 col-lg-6">
            {#Hashes info#}
            <table style="margin-bottom:0px!important;" id="crypto-table" class="table table-striped">
              <tr>
                <td class="a_grey" colspan="2"><strong>Hashes</strong></td>
              </tr>
              <tr>
                  <td class="a_grey">Hash:</td>
                  <td><a class="a_grey" href="/hash/{{rx.hash_id}}">{{ rx.hash_id }}</a></td>
              </tr>
              <tr>
                  <td class="a_grey">Previous Hash:</td>
                  <td><a class="a_grey" href="/hash/{{ rx.get_previous_hash }}">{{ rx.get_previous_hash }}</a></td>
              </tr>
            </table>
          </article>
          <article class="col-xs-12">
            <p style="padding-top:30px;color:#626262;">Public Key: <pre>{{ rx.public_key }}</pre></p>
          </article>
          <article class="col-xs-12 col-lg-6">
            <p class="text-left"><a href="/validate/{{rx.hash_id}}/" class="greybutton btn btn-primary" style="padding: .5em 4em; font-size:2em;">Validate</a></p>
          </article>

        </div>
    </div>
  </section>
  <section style="color:#626262;" class="container-fluid padding-2em bg-midnight">
    <div class="row padding-2em">
      <article class="col-xs-12 col-lg-8 col-lg-offset-2">
        Do you have the private key for this transaction? You can view it safely here.
        <button id="visualize-button" class="greybutton btn btn-primary btn-lg" type="button">Visualize</button>
        <div id="encrypt-box" class="padding-2em">
          <div class="form-group">
            <textarea id="priv_key_id"rows="4" class="form-control" name="private-key-chain" placeholder="Paste your private key here"></textarea>
            <button style="margin-top:10px;" id="decrypt-button" class="btn btn-primary btn-lg" type="submit">Decrypt</button>
            <p id="message"></p>
            <div id="qr-box" class="hidden">
              <p>Position your QR code here and click on decrypt</p>
              <div id="reader" style="width:100%;height:370px"></div>
            </div>
          </div>
        </div>
      </article>
    </div>
  </section>
{% endblock content %}

{% block jsblock %}
  <script src="{% static "js/jsencrypt.min.js" %}"></script>
  <script src="{% static "js/html5-qrcode.min.js" %}"></script>
  <script src="{% static "js/jsqrcode-combined.min.js" %}"></script>
  <script>
    $("#qr-box").toggleClass("hidden");
    $('#reader').html5_qrcode(function(data){
        // do something when code is read
        console.log(data);
        $('#messages').html("QR found!");
        $('#priv_key_id').val(data);
        $('#reader').html5_qrcode_stop();
        $("#qr-box").toggleClass("hidden");

      }, function(error){
        //show read errors
        console.log(error);

      }, function(videoError){
        //the video stream could be opened
        console.log(error);
      }
    );
    //DECRYPT FUNCTION BUTTON
    $("#decrypt-button").click(function() {
      {# TODO Make this functional! #}
      // ie. decryptBase("#medic_name");

    });
    function decryptBase(baseTextID){
      var encrypted = $(baseTextID).html();
      // Decrypt with the private key...
      var decrypt = new JSEncrypt();
      decrypt.setPrivateKey($("#priv_key_id").val());
      var uncrypted = decrypt.decrypt(encrypted);
      $(baseTextID).html(uncrypted);
    };
</script>
{% endblock jsblock %}
